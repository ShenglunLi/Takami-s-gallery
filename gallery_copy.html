<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery | TAKAMI's Portfolio</title>
    <meta name="robots" content="noindex, nofollow, noimageindex">
    <meta name="pinterest" content="nopin" description="Sorry, you can't save from this website!" />
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" />
    <link rel="stylesheet" href="style.css">

    <style>
        .info-cover-box, .viewer-img-container {
            overflow: hidden; /* 這是必須的，防止縮放後的圖片溢出到 UI 上 */
            touch-action: none; /* 禁用瀏覽器預設手勢，交給我們寫的 JS */
            position: relative;
            min-height: 300px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #infoCoverImg, #viewerImg {
            pointer-events: none; /* 讓點擊事件穿透到父容器 info-cover-box 處理 */
            user-select: none;
            -webkit-user-drag: none;
            will-change: transform;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }


    </style>

</head>
<body class="page-gallery">

    <div class="menu-toggle" id="menuBtn" onclick="toggleMenu()">
        <i class="fa-solid fa-bars menu-icon"></i>
    </div>
    <nav class="full-menu" id="fullMenu">
        <div class="close-menu" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i></div>
        <a href="index.html">Home</a>
        <a href="new.html">New</a>
        <a href="gallery.html">Gallery</a>
        <a href="life.html">Life</a>
    </nav>

    <header class="page-hero page-hero-large ">
        <div class="page-hero-bg" style="background-image: url('img/index/gallery.jpg');"></div>
        <div class="hero-content"><h1>Gallery</h1><p>作品全集</p></div>
    </header>

    <main class="gallery-main">
        <div class="category-filter" id="filterBar"></div>
        <div id="galleryContainer"></div>
    </main>

    <div id="workOverlay" class="overlay" onclick="handleOverlayClick(event)" onmousemove="resetUIInactivity()" ontouchstart="resetUIInactivity()">
        <div id="overlayCloseBtn" class="overlay-close" onclick="closeOverlay()">
            <span class="material-symbols-outlined">close</span>
        </div>
        <div id="overlayBackBtn" class="overlay-back" onclick="backToInfo()">
            <span class="material-symbols-outlined">arrow_back</span>
        </div>

        <div class="overlay-content">
            <div id="infoLayer" class="info-layer">
                <button class="info-nav-btn prev" id="infoPrev" onclick="changeWork(-1)"><i class="fas fa-chevron-left"></i></button>
                <div id="infoCoverBox" class="info-cover-box" onclick="tryEnterViewer()">
                    <img id="infoCoverImg" src="" alt="Cover">
                    <span class="page-count-label" id="infoPageCount"></span>
                </div>
                <div class="info-details">
                    <div class="info-header-meta">
                        <div class="date-tag" id="infoDate"></div>
                        <div class="clap-section" id="clapSection">
                            <button id="clapBtn" class="clap-btn">
                                <span class="material-symbols-outlined">favorite</span>
                                <span id="clapCount">-</span>
                            </button>
                            <div id="clappedStatus" style="display: none;">
                                <span class="material-symbols-outlined">favorite</span>
                                <span id="clapCountStatus">-</span><span>拍手完了</span>
                            </div>
                        </div>
                    </div>
                    <h2 id="infoTitle">作品標題</h2>
                    <p id="infoDesc">作品描述內容...</p>
                </div>
                <button class="info-nav-btn next" id="infoNext" onclick="changeWork(1)"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div id="viewerLayer" class="viewer-layer">
                <div class="viewer-img-container">
                    <button class="nav-btn prev-btn" id="viewPrev" onclick="changeInnerPage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <img id="viewerImg" src="" alt="Work Page">
                    <button class="nav-btn next-btn" id="viewNext" onclick="changeInnerPage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="viewer-indicator" id="viewerIndicator"></div>
            </div>
        </div>
    </div>
        <footer class="footer">
            <p>&copy; 2026 Takami's Gallery. All Rights Reserved.</p>
            <p>本站圖文禁止未經授權之轉載、AI 訓練與商業使用。</p>
            <p>sample@xmail.com</p>
            <ul class="sns-links">
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-plurk.png'); --hover: url('img/icon/icon-plurk-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-x.png'); --hover: url('img/icon/icon-x-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-bluesky.png'); --hover: url('img/icon/icon-bluesky-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-pixiv.png'); --hover: url('img/icon/icon-pixiv-hover.png');"></a></li>
            </ul>
        </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, off } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZ9fVnata2mqQb-YPceFKWEdKdQwL6nhA",
            authDomain: "takami-gallery.firebaseapp.com",
            databaseURL: "https://takami-gallery-default-rtdb.firebaseio.com",
            projectId: "takami-gallery",
            storageBucket: "takami-gallery.firebasestorage.app",
            messagingSenderId: "777768543738",
            appId: "1:777768543738:web:f8f0fcf7aa9cdc716f7043",
            measurementId: "G-JTZ69DZ4F4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentClapRef = null;

        document.getElementById('clapBtn').addEventListener('click', handleClap);

        window.syncClaps = function(workId) {
            if (!workId) return;
            const clapSection = document.getElementById('clapSection');
            const clapCountDisplay = document.getElementById('clapCount');
            const clapCountStatus = document.getElementById('clapCountStatus');

            clapSection.classList.remove('ready');
            if (clapCountDisplay) clapCountDisplay.innerText = "-";
            if (clapCountStatus) clapCountStatus.innerText = "-";

            checkClapLimit(workId);
            if (currentClapRef) off(currentClapRef);

            currentClapRef = ref(db, 'claps/' + workId);
            onValue(currentClapRef, (snapshot) => {
                const count = snapshot.val() || 0;
                if (clapCountDisplay) clapCountDisplay.innerText = count;
                if (clapCountStatus) clapCountStatus.innerText = count;
                setTimeout(() => { clapSection.classList.add('ready'); }, 50);
            });
        };

        // 檢查是否還在冷卻時間內 (60分鐘 = 3,600,000 毫秒)
        function checkClapLimit(workId) {
            const history = JSON.parse(localStorage.getItem('clap_history_map') || "{}");
            const lastClapTime = history[workId]; // 取得該作品上次點擊的時間戳記
            const now = Date.now();
            const cooldown = 60 * 60 * 1000; // 60 分鐘的毫秒數

            let isLocked = false;
            if (lastClapTime) {
                // 如果現在時間距離上次點擊小於冷卻時間，則鎖定按鈕
                if (now - lastClapTime < cooldown) {
                    isLocked = true;
                }
            }

            const clapBtn = document.getElementById('clapBtn');
            const clappedStatus = document.getElementById('clappedStatus');

            if (isLocked) {
                clapBtn.style.display = 'none';
                clappedStatus.style.display = 'flex';
            } else {
                clapBtn.style.display = 'flex';
                clappedStatus.style.display = 'none';
            }
        }

    // 儲存拍手時間戳記到 LocalStorage
    function saveClapToLocal(workId) {
        const history = JSON.parse(localStorage.getItem('clap_history_map') || "{}");
        history[workId] = Date.now(); // 紀錄目前時間
        localStorage.setItem('clap_history_map', JSON.stringify(history));
        checkClapLimit(workId);
    }

    // 處理點擊拍手
    function handleClap() {
        // 這裡需要能存取到 currentIndex 與 currentFilteredWorks
        // 確保這兩個變數在您的 global scope 或可存取範圍內
        const item = currentFilteredWorks[currentIndex];
        if (!item) return;

        const clapRef = ref(db, 'claps/' + item.id);
        runTransaction(clapRef, (current) => (current || 0) + 1);
        
        saveClapToLocal(item.id);
    }

    // 監聽按鈕點擊
    document.getElementById('clapBtn').addEventListener('click', handleClap);

    // 修改原本的 syncClaps 呼叫名
    window.syncClaps = function(workId) {
        if (!workId) return;
        const clapSection = document.getElementById('clapSection');
        const clapCountDisplay = document.getElementById('clapCount');
        const clapCountStatus = document.getElementById('clapCountStatus');

        clapSection.classList.remove('ready');
        if (clapCountDisplay) clapCountDisplay.innerText = "-";
        if (clapCountStatus) clapCountStatus.innerText = "-";

        // 每次切換作品時檢查該作品是否在冷卻中
        checkClapLimit(workId);

        if (currentClapRef) off(currentClapRef);
        currentClapRef = ref(db, 'claps/' + workId);
        onValue(currentClapRef, (snapshot) => {
            const count = snapshot.val() || 0;
            if (clapCountDisplay) clapCountDisplay.innerText = count;
            if (clapCountStatus) clapCountStatus.innerText = count;
            setTimeout(() => { clapSection.classList.add('ready'); }, 50);
        });
    }
    </script>

    <script>
        let allWorks = [];
        let currentFilteredWorks = []; 
        let currentIndex = 0;       
        let currentInnerIndex = 0;  
        let isViewerActive = false; 
        let uiInactivityTimeout; 
        let touchStartX = 0, touchStartY = 0, isSwiping = false;
        let scale = 1;
        let lastScale = 1;
        let startDist = 0;
        let posX = 0, posY = 0;
        let lastPosX = 0, lastPosY = 0;
        let startTouchX = 0, startTouchY = 0;
        let isZooming = false;

        async function initGallery() {
            try {
                const response = await fetch('data/content.json');
                allWorks = await response.json();
                renderFilters();
                renderCategorizedGallery('All');
                initTouchEvents();
            } catch (err) { console.error("Load Failed:", err); }
        }

        function renderFilters() {
            const categories = ['All', ...new Set(allWorks.map(w => w.category))];
            document.getElementById('filterBar').innerHTML = categories.map(cat => `
                <button class="filter-btn ${cat === 'All' ? 'active' : ''}" onclick="handleFilterClick('${cat}', this)">${cat}</button>
            `).join('');
        }

        function handleFilterClick(category, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCategorizedGallery(category);
        }

        function renderCategorizedGallery(filterTag) {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';
            currentFilteredWorks = [];
            const cats = filterTag === 'All' ? [...new Set(allWorks.map(w => w.category))] : [filterTag];

            cats.forEach(cat => {
                const works = allWorks.filter(w => w.category === cat);
                const group = document.createElement('div');
                group.className = 'category-group';
                group.innerHTML = `<h2 class="category-title">${cat}</h2><div class="gallery-grid"></div>`;
                const grid = group.querySelector('.gallery-grid');
                
                works.forEach(work => {
                    const globalIdx = currentFilteredWorks.length;
                    currentFilteredWorks.push(work);
                    const card = document.createElement('div');
                    card.className = 'work-card';
                    card.onclick = () => openOverlay(globalIdx);
                    card.innerHTML = `
                        ${work.type === 'series' ? `<div class="series-badge"><i class="fa-solid fa-copy"></i> ${work.img.length}</div>` : ''}
                        <img src="img/gallery/${work.cover || work.img[0]}" alt="${work.title}">
                    `;
                    grid.appendChild(card);
                });
                container.appendChild(group);
            });
        }

        // 建立一個統一修正高度的函式
        function fixOverlayHeight() {
            const overlay = document.getElementById('workOverlay');
            if (overlay && overlay.classList.contains('active')) {
                // 使用 window.innerHeight 取得排除瀏覽器工具欄後的真實像素高度
                overlay.style.height = window.innerHeight + 'px';
            }
        }

        function openOverlay(index) {
            currentIndex = index;
            isViewerActive = false;
            currentInnerIndex = 0;
            document.getElementById('clapSection').classList.remove('ready');
            
            updateOverlayUI();
            
            const overlay = document.getElementById('workOverlay');
            overlay.classList.add('active');
            
            // 開啟時立即修正一次高度
            fixOverlayHeight();
            
            document.body.style.overflow = 'hidden';
            document.body.style.backgroundColor = '#000000'; // 開啟時將底色變黑
        }

        // 監聽螢幕旋轉或視窗大小改變（例如導覽列隱藏時）
        window.addEventListener('resize', fixOverlayHeight);

        // 額外處理：針對 iOS Chrome 導覽列消失後的瞬間補償
        window.addEventListener('scroll', () => {
            if (document.getElementById('workOverlay').classList.contains('active')) {
                fixOverlayHeight();
            }
        });

        function updateOverlayUI() {

            // 切換作品前，務必將縮放數值歸零
            resetAllZoom(); 

            const item = currentFilteredWorks[currentIndex];
            if (!item) return;

            const coverFile = item.cover || (Array.isArray(item.img) ? item.img[0] : item.img);
            document.getElementById('infoCoverImg').src = `img/gallery/${coverFile}`;
            document.getElementById('infoTitle').innerText = item.title;
            document.getElementById('infoDesc').innerText = item.desc || "";
            document.getElementById('infoDate').innerText = item.date;

            const currentCat = item.category;
            const infoPrev = document.getElementById('infoPrev');
            const infoNext = document.getElementById('infoNext');
            if (infoPrev) infoPrev.style.visibility = (currentIndex > 0 && currentFilteredWorks[currentIndex-1].category === currentCat) ? 'visible' : 'hidden';
            if (infoNext) infoNext.style.visibility = (currentIndex < currentFilteredWorks.length - 1 && currentFilteredWorks[currentIndex+1].category === currentCat) ? 'visible' : 'hidden';

            const isSeries = item.type === 'series';
            const pageBadge = document.getElementById('infoPageCount');
            const coverBox = document.getElementById('infoCoverBox');

            if (isSeries) {
                pageBadge.innerText = `繼續閱讀 ${item.img.length}P`;
                pageBadge.classList.add('active');
                coverBox.classList.add('is-series');
            } else {
                pageBadge.classList.remove('active');
                coverBox.classList.remove('is-series');
            }

            if (isViewerActive && isSeries) {
                document.getElementById('infoLayer').style.display = 'none';
                document.getElementById('viewerLayer').classList.add('active');
                document.getElementById('overlayCloseBtn').style.display = 'none';
                document.getElementById('overlayBackBtn').style.display = 'flex';
                updateViewerImage();
            } else {
                document.getElementById('infoLayer').style.display = 'flex';
                document.getElementById('viewerLayer').classList.remove('active');
                document.getElementById('overlayCloseBtn').style.display = 'flex';
                document.getElementById('overlayBackBtn').style.display = 'none';
            }

            if (window.syncClaps) window.syncClaps(item.id);
        }

        function updateViewerImage() {

            resetAllZoom(); // 換頁時重置縮放

            const item = currentFilteredWorks[currentIndex];
            const imgs = item.img;
            document.getElementById('viewerImg').src = `img/gallery/${imgs[currentInnerIndex]}`;
            
            const viewPrev = document.getElementById('viewPrev');
            const viewNext = document.getElementById('viewNext');
            if (viewPrev) viewPrev.classList.toggle('btn-hidden', currentInnerIndex === 0);
            if (viewNext) viewNext.classList.toggle('btn-hidden', currentInnerIndex === imgs.length - 1);

            const indicator = document.getElementById('viewerIndicator');
            indicator.innerHTML = imgs.map((_, i) => `<span class="dot ${i === currentInnerIndex ? 'active' : ''}"></span>`).join('');
        }

        function changeWork(step) {
            const newIdx = currentIndex + step;
            if (newIdx >= 0 && newIdx < currentFilteredWorks.length) {
                if (currentFilteredWorks[newIdx].category === currentFilteredWorks[currentIndex].category) {
                    currentIndex = newIdx;
                    currentInnerIndex = 0;
                    document.getElementById('clapCount').innerText = "-";
                    document.getElementById('clapCountStatus').innerText = "-";
                    updateOverlayUI();
                }
            }
        }

        function changeInnerPage(step) {
            const item = currentFilteredWorks[currentIndex];
            const targetIndex = currentInnerIndex + step;
            if (targetIndex >= 0 && targetIndex < item.img.length) {
                currentInnerIndex = targetIndex;
                updateViewerImage();
            }
        }

        function enterViewer() { isViewerActive = true; currentInnerIndex = 0; updateOverlayUI(); }
        function backToInfo() { isViewerActive = false; updateOverlayUI(); }
        function closeOverlay() {
        document.getElementById('workOverlay').classList.remove('active');
        document.body.style.overflow = 'auto';
        document.body.style.backgroundColor = ''; // 關閉時還原底色
    }
        function handleOverlayClick(e) { if (e.target.id === 'workOverlay') closeOverlay(); }
        function tryEnterViewer() { if (currentFilteredWorks[currentIndex].type === 'series') enterViewer(); }

        function initTouchEvents() {
    const infoBox = document.getElementById('infoCoverBox');
    const viewerBox = document.querySelector('.viewer-img-container');

    const handleStart = (e) => {
        if (e.touches.length === 2) {
            // 雙指開始縮放
            isZooming = true;
            startDist = getDistance(e.touches[0], e.touches[1]);
        } else if (e.touches.length === 1) {
            // 單指開始
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            startTouchX = e.touches[0].clientX - posX;
            startTouchY = e.touches[0].clientY - posY;
            isSwiping = (scale <= 1.1); // 只有沒縮放時才啟動滑動切換
        }
    };

    const handleMove = (e) => {
        const targetImg = isViewerActive ? document.getElementById('viewerImg') : document.getElementById('infoCoverImg');
        if (!targetImg) return;

        if (e.touches.length === 2 && isZooming) {
            // 雙指縮放中
            e.preventDefault();
            const currentDist = getDistance(e.touches[0], e.touches[1]);
            const diff = currentDist / startDist;
            scale = Math.min(Math.max(1, lastScale * diff), 3); // 限制 1~3 倍
            updateTransform(targetImg);
        } else if (e.touches.length === 1) {
            if (scale > 1.1) {
                // 縮放狀態下的單指拖動 (Pan)
                e.preventDefault();
                posX = e.touches[0].clientX - startTouchX;
                posY = e.touches[0].clientY - startTouchY;
                
                // 簡單的邊界檢查建議 (可選)
                updateTransform(targetImg);
            } else if (isSwiping) {
                // 1x 狀態下的水平滑動預覽
                let dx = e.touches[0].clientX - touchStartX;
                let dy = e.touches[0].clientY - touchStartY;
                if (Math.abs(dx) > Math.abs(dy)) {
                    if (e.cancelable) e.preventDefault();
                    targetImg.style.transform = `translateX(${dx * 0.3}px)`;
                    targetImg.style.transition = 'none';
                }
            }
        }
    };

    const handleEnd = (e) => {
        const targetImg = isViewerActive ? document.getElementById('viewerImg') : document.getElementById('infoCoverImg');
        
        if (isZooming) {
            lastScale = scale;
            if (e.touches.length < 2) isZooming = false;
        }

        if (scale <= 1.1) {
            // 處理作品切換
            let dx = e.changedTouches[0].clientX - touchStartX;
            if (targetImg) {
                targetImg.style.transition = 'transform 0.3s ease';
                targetImg.style.transform = 'scale(1) translate(0,0)';
            }
            if (isSwiping && Math.abs(dx) > 70) {
                isViewerActive ? changeInnerPage(dx < 0 ? 1 : -1) : changeWork(dx < 0 ? 1 : -1);
            }
            // 重設位移數值
            posX = 0; posY = 0; lastPosX = 0; lastPosY = 0;
        }
        isSwiping = false;
    };

    // 輔助函式
    function getDistance(t1, t2) {
        return Math.sqrt(Math.pow(t2.pageX - t1.pageX, 2) + Math.pow(t2.pageY - t1.pageY, 2));
    }

    function updateTransform(el) {
        el.style.transition = 'none';
        el.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    [infoBox, viewerBox].forEach(box => {
        if (box) {
            box.addEventListener('touchstart', handleStart, { passive: false });
            box.addEventListener('touchmove', handleMove, { passive: false });
            box.addEventListener('touchend', handleEnd, { passive: true });
        }
    });
}

function resetAllZoom() {
    scale = 1;
    lastScale = 1;
    posX = 0;
    posY = 0;
    const imgs = [document.getElementById('infoCoverImg'), document.getElementById('viewerImg')];
    imgs.forEach(img => {
        if (img) {
            img.style.transition = 'transform 0.2s ease';
            img.style.transform = 'scale(1) translate(0,0)';
        }
    });
}

function tryEnterViewer() {
    // 只有在完全沒縮放，且不是在滑動中才允許進入
    if (scale <= 1.05 && !isZooming) {
        if (currentFilteredWorks[currentIndex].type === 'series') enterViewer();
    }
}

        function resetUIInactivity() {
            const btns = [document.getElementById('overlayBackBtn'), document.getElementById('overlayCloseBtn')];
            btns.forEach(b => b && b.classList.remove('ui-hidden'));
            clearTimeout(uiInactivityTimeout);
            uiInactivityTimeout = setTimeout(() => {
                if (isViewerActive && window.innerWidth <= 900) btns.forEach(b => b && b.classList.add('ui-hidden'));
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', initGallery);
    </script>

    <script src="main.js"></script>
</body>
</html>