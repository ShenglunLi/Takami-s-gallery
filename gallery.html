<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gallery | TAKAMI's Portfolio</title>
    <meta name="robots" content="noindex, nofollow, noimageindex">
    <meta name="pinterest" content="nopin" description="Sorry, you can't save from this website!" />
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" />
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- Gallery 基礎樣式 --- */
        .gallery-main { padding: 40px 0; min-height: 80vh; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .category-filter { display: flex; justify-content: flex-start; gap: 12px; margin-top: 20px; margin-bottom: 40px; flex-wrap: wrap; }
        .filter-btn { padding: 6px 24px; border: 1px solid var(--primary-color); background: transparent; color: var(--primary-color); border-radius: var(--radius-full); cursor: pointer; transition: 0.3s; }
        .filter-btn.active, .filter-btn:hover { background: var(--primary-color); color: #fff; }
        .category-group { margin-bottom: 60px; position: relative; }
        .category-title { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--text-light-subtitle); font-weight: 700; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }

        /* --- 網格卡片樣式 --- */
        .work-card { position: relative; background: #eee; aspect-ratio: 1 / 1; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .work-card:hover { opacity: 0.9; transform: scale(1.02); }
        .work-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .series-badge { position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.6); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; z-index: 5; }

        /* --- Overlay 燈箱樣式 --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 1000; overflow: hidden; align-items: center; justify-content: center; }
        .overlay.active { display: flex; }
 
        .overlay-close, .overlay-back {
            position: fixed;
            top: 30px;
            right: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            cursor: pointer;
            z-index: 1010;
            transition: 0.3s;
            border: none;
        }

        .overlay-close:hover, .overlay-back:hover { background: rgba(255, 255, 255, 0.15); }

        .overlay-close .material-symbols-outlined, 
        .overlay-back .material-symbols-outlined {
            font-weight: 100;
            font-size: 2rem;
            color: #fff;
        }

        /* 初始狀態控制 */
        .overlay-close { display: flex; }
        .overlay-back { display: none; }


        .overlay-content { width: 85%; max-width: 1200px; display: flex; flex-direction: column; position: relative; margin: 0 auto; }

        /* --- 第一層：資訊層 (Info Layer) --- */
        .info-layer { display: flex; gap: 60px; align-items: stretch; background: transparent; }
        
        .info-cover-box { 
            flex: 0 0 60%; 
            position: relative; 
            max-height: 85vh; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .info-cover-box.is-series { cursor: pointer; }
        .info-cover-box img { 
            width: 100%; 
            height: 100%; 
            max-height: 85vh; 
            object-fit: contain; 
            border-radius: 4px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            display: block; 
        }

        /* --- 修正 2：Info Layer 圓形導覽按鈕 & 位置對齊 --- */
        .info-nav-btn {
            position: fixed; /* 改為定點位置 */
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 1005;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border-radius: 50%; /* 圓形 */
        }
        
        @media (min-width: 901px) {
            .info-nav-btn:hover { background: rgba(255, 255, 255, 0.15); }
            .info-nav-btn.prev { left: 30px; } /* 靠左邊界 */
            .info-nav-btn.next { right: 30px; } /* 修正：水平位置對齊 overlayCloseBtn */
        }

        .page-count-label { position: absolute; bottom: 15px; right: 15px; color: #fff; background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 8px; font-size: 0.9rem; font-family: monospace; display: none; }
        .page-count-label.active { display: block; }
        
        .info-details { 
            flex: 1; 
            color: #fff; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            text-align: left; 
            padding: 20px 0; 
        }
        .info-details h2 { font-size: 2.4rem; margin: 10px 0 15px 0; color: #fff; font-weight: 700; line-height: 1.2; }
        .info-details p { font-size: 1.1rem; line-height: 1.8; color: #ccc; margin-bottom: 25px; overflow-y: auto; }
        .info-details .date-tag { font-size: 0.95rem; color: var(--primary-hover); font-weight: bold; margin-bottom: 5px; opacity: 0.9; }

        .read-btn {
            margin-top: auto;
            align-self: flex-start;
            padding: 12px 45px;
            background-color: transparent;
            color: #fff;
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            display: none; 
            align-items: center;
            gap: 10px;
        }
        .read-btn.active { display: flex; }

        /* --- 第二層：瀏覽層 (Viewer Layer) --- */
        .viewer-layer { 
            display: none; 
            width: 100%; 
            height: 90vh; /* 需求 1：減少高度（從 90vh 改為 80vh 或您需要的高度） */
            position: relative; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            /* 必須改為 visible，否則 bottom: -10px 的圓點會被切掉看不到 */
            overflow: visible; 
        }
        .viewer-layer.active { display: flex; }
        .viewer-img-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .viewer-img-container img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* 修正 1：Viewer 層按鈕定位 (電腦版保留) */
        .nav-btn {
            position: absolute; top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.05);
            color: #fff;
            border: none;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.3s;
            z-index: 20;
            border-radius: 50%; /* 圓形 */ }

        
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .prev-btn { left: 20px; }
        .next-btn { right: 20px; }
        
        /* 輔助：隱藏按鈕但保留空間或邏輯 */
        .btn-hidden { visibility: hidden !important; pointer-events: none !important; }

        .viewer-indicator { 
            position: absolute; 
            bottom: -20px; 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            justify-content: center; 
        }
        .dot { width: 8px; height: 8px; background: var(--dot-color); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: var(--dot-active-color); transform: scale(1.2); }

        /* --- RWD 修正 --- */
        @media (max-width: 900px) {
            #workOverlay { overflow: hidden; align-items: center; }
            .viewer-layer {
                width: 100vw;
                height: 100vh;
                height: 100dvh;
                padding: 0;
            }
            .overlay-content { width: 100%; height: 100%; max-width: none; justify-content: center; }

            /* 修正 1: 手機版隱藏左右按鈕 */
            .nav-btn, .info-nav-btn {
                display: none !important;
            }

            .info-layer { flex-direction: column; gap: 8px; padding-top: 60px; overflow-y: auto; height: 100%; }
            .info-cover-box { flex: 0 0 auto; width: 100%; }
            .info-cover-box img { max-height: 50vh; }
            .info-details { padding: 20px; }
            
            .overlay-close, .overlay-back {
                top: 20px;
                left: 20px;
                right: auto;
                background: rgba(0, 0, 0, 0.4);
                backdrop-filter: blur(4px);
            }
            .overlay-back.ui-hidden, .overlay-close.ui-hidden { opacity: 0; pointer-events: none; }

            .viewer-indicator {bottom: 10px; }
        }
    </style>
</head>
<body>

    <div class="menu-toggle" id="menuBtn" onclick="toggleMenu()">
        <i class="fa-solid fa-bars menu-icon"></i>
    </div>
    <nav class="full-menu" id="fullMenu">
        <div class="close-menu" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i></div>
        <a href="index.html">Home</a>
        <a href="new.html">New</a>
        <a href="gallery.html">Gallery</a>
        <a href="life.html">Life</a>
    </nav>

    <header class="new-hero" style="height: 30vh;">
        <div class="new-hero-bg" style="background-image: url('img/index/gallery.jpg');"></div>
        <div class="hero-content"><p>Gallery</p><h1>作品全集</h1></div>
    </header>

    <main class="gallery-main">
        <div class="category-filter" id="filterBar"></div>
        <div id="galleryContainer"></div>
    </main>

    <div id="workOverlay" class="overlay" onclick="handleOverlayClick(event)" onmousemove="resetUIInactivity()" ontouchstart="resetUIInactivity()">
        <div id="overlayCloseBtn" class="overlay-close" onclick="closeOverlay()">
            <span class="material-symbols-outlined">close</span>
        </div>
        <div id="overlayBackBtn" class="overlay-back" onclick="backToInfo()">
            <span class="material-symbols-outlined">arrow_back</span>
        </div>

        <div class="overlay-content">
            <div id="infoLayer" class="info-layer">
                <button class="info-nav-btn prev" id="infoPrev" onclick="changeWork(-1)"><i class="fas fa-chevron-left"></i></button>
                
                <div id="infoCoverBox" class="info-cover-box">
                    <img id="infoCoverImg" src="" alt="Cover" onclick="tryEnterViewer()">
                    <span class="page-count-label" id="infoPageCount"></span>
                </div>

                <div class="info-details">
                    <div class="date-tag" id="infoDate"></div>
                    <h2 id="infoTitle">作品標題</h2>
                    <p id="infoDesc">作品描述內容...</p>
                    <div class="clap-section">
                        <button id="clapBtn" class="clap-btn">
                            <span class="material-symbols-outlined">favorite</span>
                            <span id="clapCount">0</span>
                        </button>
                        <div id="clappedStatus" style="display: none; color: var(--primary-hover); font-weight: bold; align-items: center; gap: 8px;">
                            <span class="material-symbols-outlined">favorite</span>
                            <span id="clapCountStatus">0</span><span>拍手完了</span>
                        </div>
                    </div>
                    <button id="infoReadBtn" class="read-btn" onclick="enterViewer()">
                        <span class="material-symbols-outlined">auto_stories</span> 開始閱讀
                    </button>
                </div>
                <button class="info-nav-btn next" id="infoNext" onclick="changeWork(1)"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div id="viewerLayer" class="viewer-layer">
                <div class="viewer-img-container">
                    <button class="nav-btn prev-btn" id="viewPrev" onclick="changeInnerPage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <img id="viewerImg" src="" alt="Work Page">
                    <button class="nav-btn next-btn" id="viewNext" onclick="changeInnerPage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="viewer-indicator" id="viewerIndicator"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, off } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZ9fVnata2mqQb-YPceFKWEdKdQwL6nhA",
            authDomain: "takami-gallery.firebaseapp.com",
            databaseURL: "https://takami-gallery-default-rtdb.firebaseio.com",
            projectId: "takami-gallery",
            storageBucket: "takami-gallery.firebasestorage.app",
            messagingSenderId: "777768543738",
            appId: "1:777768543738:web:f8f0fcf7aa9cdc716f7043",
            measurementId: "G-JTZ69DZ4F4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentClapRef = null;

        document.getElementById('clapBtn').addEventListener('click', handleClap);

        window.syncClaps = function(workId) {
            if (!workId) return;
            checkClapLimit(workId);
            if (currentClapRef) off(currentClapRef);
            currentClapRef = ref(db, 'claps/' + workId);
            onValue(currentClapRef, (snapshot) => {
                const count = snapshot.val() || 0;
                document.getElementById('clapCount').innerText = count;
                document.getElementById('clapCountStatus').innerText = count;
            });
        };

        function handleClap() {
            const item = currentFilteredWorks[currentIndex];
            if (!item) return;
            const clapRef = ref(db, 'claps/' + item.id);
            runTransaction(clapRef, (current) => (current || 0) + 1);
            saveClapToLocal(item.id);
        }

        function checkClapLimit(workId) {
            const history = JSON.parse(localStorage.getItem('clap_history') || "[]");
            const isClapped = history.includes(workId);
            document.getElementById('clapBtn').style.display = isClapped ? 'none' : 'flex';
            document.getElementById('clappedStatus').style.display = isClapped ? 'flex' : 'none';
        }

        function saveClapToLocal(workId) {
            const history = JSON.parse(localStorage.getItem('clap_history') || "[]");
            history.push(workId);
            localStorage.setItem('clap_history', JSON.stringify(history));
            checkClapLimit(workId);
        }
    </script>

    <script>
        let allWorks = [];
        let currentFilteredWorks = []; 
        let currentIndex = 0;       
        let currentInnerIndex = 0;  
        let isViewerActive = false; 
        let uiInactivityTimeout; 
        let touchStartX = 0, touchStartY = 0, isSwiping = false;

        async function initGallery() {
            try {
                const response = await fetch('data/content.json');
                allWorks = await response.json();
                renderFilters();
                renderCategorizedGallery('All');
                initTouchEvents();
            } catch (err) { console.error("Load Failed:", err); }
        }

        function renderFilters() {
            const categories = ['All', ...new Set(allWorks.map(w => w.category))];
            document.getElementById('filterBar').innerHTML = categories.map(cat => `
                <button class="filter-btn ${cat === 'All' ? 'active' : ''}" onclick="handleFilterClick('${cat}', this)">${cat}</button>
            `).join('');
        }

        function handleFilterClick(category, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCategorizedGallery(category);
        }

        function renderCategorizedGallery(filterTag) {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';
            currentFilteredWorks = [];
            const cats = filterTag === 'All' ? [...new Set(allWorks.map(w => w.category))] : [filterTag];

            cats.forEach(cat => {
                const works = allWorks.filter(w => w.category === cat);
                const group = document.createElement('div');
                group.className = 'category-group';
                group.innerHTML = `<h2 class="category-title">${cat}</h2><div class="gallery-grid"></div>`;
                const grid = group.querySelector('.gallery-grid');
                
                works.forEach(work => {
                    const globalIdx = currentFilteredWorks.length;
                    currentFilteredWorks.push(work);
                    const card = document.createElement('div');
                    card.className = 'work-card';
                    card.onclick = () => openOverlay(globalIdx);
                    card.innerHTML = `
                        ${work.type === 'series' ? `<div class="series-badge"><i class="fa-solid fa-copy"></i> ${work.img.length}</div>` : ''}
                        <img src="img/gallery/${work.cover || work.img[0]}" alt="${work.title}">
                    `;
                    grid.appendChild(card);
                });
                container.appendChild(group);
            });
        }

        function openOverlay(index) {
            currentIndex = index;
            isViewerActive = false;
            updateOverlayUI();
            document.getElementById('workOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function updateOverlayUI() {
            const item = currentFilteredWorks[currentIndex];
            document.getElementById('infoCoverImg').src = `img/gallery/${item.cover || item.img[0]}`;
            document.getElementById('infoTitle').innerText = item.title;
            document.getElementById('infoDesc').innerText = item.desc || "";
            document.getElementById('infoDate').innerText = item.date;

            // Info Layer 換頁按鈕 (同類別顯示)
            const currentCat = item.category;
            const infoPrev = document.getElementById('infoPrev');
            const infoNext = document.getElementById('infoNext');
            if (infoPrev) infoPrev.style.visibility = (currentIndex > 0 && currentFilteredWorks[currentIndex-1].category === currentCat) ? 'visible' : 'hidden';
            if (infoNext) infoNext.style.visibility = (currentIndex < currentFilteredWorks.length - 1 && currentFilteredWorks[currentIndex+1].category === currentCat) ? 'visible' : 'hidden';

            const isSeries = item.type === 'series';
            document.getElementById('infoPageCount').innerText = isSeries ? `繼續閱讀 ${item.img.length}P` : "";
            document.getElementById('infoPageCount').classList.toggle('active', isSeries);
            document.getElementById('infoReadBtn').classList.toggle('active', isSeries);

            if (isViewerActive) {
                document.getElementById('infoLayer').style.display = 'none';
                document.getElementById('viewerLayer').classList.add('active');
                document.getElementById('overlayCloseBtn').style.display = 'none';
                document.getElementById('overlayBackBtn').style.display = 'flex';
                updateViewerImage();
            } else {
                document.getElementById('infoLayer').style.display = 'flex';
                document.getElementById('viewerLayer').classList.remove('active');
                document.getElementById('overlayCloseBtn').style.display = 'flex';
                document.getElementById('overlayBackBtn').style.display = 'none';
            }
            if (window.syncClaps) window.syncClaps(item.id);
        }

        // 修正 3: 更新 Viewer 圖片與按鈕隱藏邏輯 (禁止循環)
        function updateViewerImage() {
            const item = currentFilteredWorks[currentIndex];
            const imgs = item.img;
            document.getElementById('viewerImg').src = `img/gallery/${imgs[currentInnerIndex]}`;
            
            // 處理電腦版按鈕隱藏 (禁止循環換頁)
            const viewPrev = document.getElementById('viewPrev');
            const viewNext = document.getElementById('viewNext');
            
            if (viewPrev) viewPrev.classList.toggle('btn-hidden', currentInnerIndex === 0);
            if (viewNext) viewNext.classList.toggle('btn-hidden', currentInnerIndex === imgs.length - 1);

            const indicator = document.getElementById('viewerIndicator');
            indicator.innerHTML = imgs.map((_, i) => `<span class="dot ${i === currentInnerIndex ? 'active' : ''}"></span>`).join('');
        }

        function changeWork(step) {
            const newIdx = currentIndex + step;
            if (newIdx >= 0 && newIdx < currentFilteredWorks.length) {
                if (currentFilteredWorks[newIdx].category === currentFilteredWorks[currentIndex].category) {
                    currentIndex = newIdx;
                    currentInnerIndex = 0;
                    updateOverlayUI();
                }
            }
        }

        // 修正 3: 修改換頁邏輯，不允許循環
        function changeInnerPage(step) {
            const item = currentFilteredWorks[currentIndex];
            const imgs = item.img;
            const targetIndex = currentInnerIndex + step;

            // 禁止循環換頁攔截
            if (targetIndex < 0 || targetIndex >= imgs.length) {
                return; 
            }

            currentInnerIndex = targetIndex;
            updateViewerImage();
        }

        function enterViewer() { isViewerActive = true; currentInnerIndex = 0; updateOverlayUI(); }
        function backToInfo() { isViewerActive = false; updateOverlayUI(); }
        function closeOverlay() { document.getElementById('workOverlay').classList.remove('active'); document.body.style.overflow = 'auto'; }
        function handleOverlayClick(e) { if (e.target.id === 'workOverlay') closeOverlay(); }
        function tryEnterViewer() { if (currentFilteredWorks[currentIndex].type === 'series') enterViewer(); }

        function initTouchEvents() {
            const overlay = document.getElementById('workOverlay');
            overlay.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = true;
            }, {passive: true});

            overlay.addEventListener('touchmove', e => {
                if (!isSwiping) return;
                let dx = e.touches[0].clientX - touchStartX;
                let dy = e.touches[0].clientY - touchStartY;
                if (Math.abs(dx) > Math.abs(dy)) {
                    const img = isViewerActive ? document.getElementById('viewerImg') : document.getElementById('infoCoverImg');
                    img.style.transform = `translateX(${dx * 0.2}px)`;
                }
            }, {passive: true});

            overlay.addEventListener('touchend', e => {
                isSwiping = false;
                let dx = e.changedTouches[0].clientX - touchStartX;
                const img = isViewerActive ? document.getElementById('viewerImg') : document.getElementById('infoCoverImg');
                img.style.transform = '';
                if (Math.abs(dx) > 80) {
                    dx < 0 ? (isViewerActive ? changeInnerPage(1) : changeWork(1)) : (isViewerActive ? changeInnerPage(-1) : changeWork(-1));
                }
            }, {passive: true});
        }

        function resetUIInactivity() {
            const btns = [document.getElementById('overlayBackBtn'), document.getElementById('overlayCloseBtn')];
            btns.forEach(b => b && b.classList.remove('ui-hidden'));
            clearTimeout(uiInactivityTimeout);
            uiInactivityTimeout = setTimeout(() => {
                if (isViewerActive && window.innerWidth <= 900) btns.forEach(b => b && b.classList.add('ui-hidden'));
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', initGallery);
    </script>

    <script>
        const menuBtn = document.getElementById('menuBtn');
        const fullMenu = document.getElementById('fullMenu');
        let lastScrollY = window.scrollY;

        function toggleMenu() {
            if (!fullMenu || !menuBtn) return;
            const isActive = fullMenu.classList.toggle('active');
            if (isActive) {
                menuBtn.classList.add('hidden');
            } else {
                menuBtn.classList.remove('hidden');
            }
        }

        window.addEventListener('scroll', () => {
            if (fullMenu.classList.contains('active')) return;
            const currentScrollY = window.scrollY;
            const delta = currentScrollY - lastScrollY;
            if (delta > 0 && currentScrollY > 50) {
                menuBtn.classList.add('hidden');
            } else if (delta < 0) {
                menuBtn.classList.remove('hidden');
            }
            lastScrollY = currentScrollY;
        });
    </script>

    <script>
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
        document.addEventListener('copy', e => e.preventDefault());
        document.addEventListener('dragstart', e => {
            if (e.target.tagName === 'IMG') e.preventDefault();
        });
    </script>

</body>
</html>