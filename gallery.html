<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gallery | TAKAMI's Portfolio</title>
    <meta name="robots" content="noindex, nofollow, noimageindex">
    <meta name="pinterest" content="nopin" description="Sorry, you can't save from this website!" />
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" />
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- Gallery 基礎樣式 --- */
        .gallery-main { padding: 40px 0; min-height: 80vh; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .category-filter { display: flex; justify-content: flex-start; gap: 12px; margin-top: 20px; margin-bottom: 40px; flex-wrap: wrap; }
        .filter-btn { padding: 6px 24px; border: 1px solid var(--primary-color); background: transparent; color: var(--primary-color); border-radius: var(--radius-full); cursor: pointer; transition: 0.3s; }
        .filter-btn.active, .filter-btn:hover { background: var(--primary-color); color: #fff; }
        .category-group { margin-bottom: 40px; position: relative; }
        .category-title { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--text-light-subtitle); font-weight: 700; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }

        /* --- 網格卡片樣式 --- */
        .work-card { position: relative; background: #eee; aspect-ratio: 1 / 1; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .work-card:hover { opacity: 0.9; transform: scale(1.02); }
        .work-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .series-badge { position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.6); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; z-index: 5; }

/* --- Overlay 燈箱樣式修正 --- */
        .overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            /* 預設使用 100dvh，JS 會再賦予精確像素值 */
            height: 100dvh; 
            background: #000000; 
            display: none; 
            z-index: 1000; 
            overflow: hidden; 
            align-items: center; 
            justify-content: center;
            touch-action: none; 
            /* 處理 iOS 安全區域 */
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }
        
        .overlay.active { display: flex; }
 
        .overlay-close, .overlay-back {
            position: fixed; top: 30px; right: 30px;
            display: flex; align-items: center; justify-content: center;
            width: 48px; height: 48px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%; cursor: pointer; z-index: 1010; transition: 0.3s; border: none;
        }
        .overlay-close:hover, .overlay-back:hover { background: rgba(255, 255, 255, 0.15); }
        .overlay-close .material-symbols-outlined, .overlay-back .material-symbols-outlined { font-weight: 100; font-size: 2rem; color: #fff; }

        .overlay-content { 
            position: relative; width: 85%; max-width: 1200px; height: 85vh; 
            display: flex; align-items: center; justify-content: center; margin: 0 auto; 
        }

        /* --- 第一層：資訊層 (Info Layer) --- */
        .info-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; gap: 60px; align-items: center; background: transparent; 
        }
        
        .info-cover-box { 
            flex: 0 0 60%; position: relative; max-height: 85vh; 
            display: flex; align-items: center; justify-content: center;
        }
        .info-cover-box img { 
            width: 100%; height: 100%; max-height: 85vh; object-fit: contain; 
            border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.1s ease-out; /* 讓跟手動畫平滑 */
        }
        .info-cover-box.is-series { cursor: pointer; transition: transform 0.3s ease; }
        .info-cover-box.is-series:hover { transform: scale(1.01); }

        .info-nav-btn {
            position: fixed; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.05); color: white; border: none;
            width: 50px; height: 50px; cursor: pointer; z-index: 1005;
            transition: 0.3s; display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .info-nav-btn.prev { left: 30px; }
        .info-nav-btn.next { right: 30px; }

        .page-count-label { position: absolute; bottom: 15px; right: 15px; color: #fff; background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 8px; font-size: 0.9rem; display: none; }
        .page-count-label.active { display: block; }
        
        .info-details {
            flex: 1; display: flex; flex-direction: column; align-items: flex-start;
            padding: 20px 0; min-width: 300px;
        }
        .info-details h2 { font-size: 2.4rem; margin: 10px 0 15px 0; color: #fff; font-weight: 700; line-height: 1.2; }
        .info-details p { font-size: 1.1rem; line-height: 1.8; color: #ccc; margin-bottom: 25px; }

        .info-header-meta {
            display: flex; justify-content: space-between; align-items: flex-start;
            width: 100%; margin-bottom: 10px; min-height: 32px;
        }
        .date-tag { font-size: 0.95rem; color: var(--primary-hover); font-weight: bold; line-height: 1.8; }

        /* .clap-section {
            flex-shrink: 0; opacity: 0; visibility: hidden;
            transition: opacity 0.4s ease; min-height: 32px;
            display: flex; align-items: center;
        }
        .clap-section.ready { opacity: 1; visibility: visible; }

        .clap-btn, #clappedStatus {
            background: transparent; border: none; color: #ccc;
            display: flex; align-items: center; gap: 8px;
            font-size: 0.95rem !important; font-weight: 500;
            padding: 4px 0; cursor: pointer; transition: 0.3s;
        }
        #clappedStatus { color: var(--primary-hover) !important; cursor: default; }
        .clap-btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 200; font-size: 22px; }
        #clappedStatus .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 200; } */

        /* --- 第二層：瀏覽層 (Viewer Layer) --- */
        .viewer-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; background: #000;
        }
        .viewer-layer.active { display: flex; }
        .viewer-img-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .viewer-img-container img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.1s ease-out; }

        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.05); color: #fff; border: none;
            width: 50px; height: 50px; cursor: pointer; border-radius: 50%; z-index: 30;
        }
        .prev-btn { left: 20px; } .next-btn { right: 20px; }
        .btn-hidden { visibility: hidden !important; }

        .viewer-indicator { position: absolute; bottom: -20px; display: flex; gap: 8px; }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.2); }

        /* --- RWD 修正 --- */
        @media (max-width: 900px) {
            .overlay-content { width: 100%; height: 100%; }
            .info-layer { 
                flex-direction: column; gap: 8px; padding-top: 60px; 
                overflow-y: auto; position: relative; 
                touch-action: pan-y; /* 手機板資訊層允許垂直捲動文字 */
            }
            .info-cover-box { flex: 0 0 auto; width: 100%; touch-action: none; }
            .info-cover-box img { max-height: 50vh; }
            .info-details { padding: 20px; width: 100%; box-sizing: border-box; }
            .viewer-layer { height: 100%; touch-action: none; }
            .nav-btn, .info-nav-btn { display: none !important; }
            .overlay-close, .overlay-back { top: 20px; left: 20px; right: auto; background: rgba(0,0,0,0.5); }
            .ui-hidden { opacity: 0; pointer-events: none; }
        }
    </style>
</head>
<body>

    <div class="menu-toggle" id="menuBtn" onclick="toggleMenu()">
        <i class="fa-solid fa-bars menu-icon"></i>
    </div>
    <nav class="full-menu" id="fullMenu">
        <div class="close-menu" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i></div>
        <a href="index.html">Home</a>
        <a href="new.html">New</a>
        <a href="gallery.html">Gallery</a>
        <a href="life.html">Life</a>
    </nav>

    <header class="new-hero" style="height: 30vh;">
        <div class="new-hero-bg" style="background-image: url('img/index/gallery.jpg');"></div>
        <div class="hero-content"><p>Gallery</p><h1>作品全集</h1></div>
    </header>

    <main class="gallery-main">
        <div class="category-filter" id="filterBar"></div>
        <div id="galleryContainer"></div>
    </main>

    <div id="workOverlay" class="overlay" onclick="handleOverlayClick(event)" onmousemove="resetUIInactivity()" ontouchstart="resetUIInactivity()">
        <div id="overlayCloseBtn" class="overlay-close" onclick="closeOverlay()">
            <span class="material-symbols-outlined">close</span>
        </div>
        <div id="overlayBackBtn" class="overlay-back" onclick="backToInfo()">
            <span class="material-symbols-outlined">arrow_back</span>
        </div>

        <div class="overlay-content">
            <div id="infoLayer" class="info-layer">
                <button class="info-nav-btn prev" id="infoPrev" onclick="changeWork(-1)"><i class="fas fa-chevron-left"></i></button>
                <div id="infoCoverBox" class="info-cover-box" onclick="tryEnterViewer()">
                    <img id="infoCoverImg" src="" alt="Cover">
                    <span class="page-count-label" id="infoPageCount"></span>
                </div>
                <div class="info-details">
                    <div class="info-header-meta">
                        <div class="date-tag" id="infoDate"></div>
                        <div class="clap-section" id="clapSection">
                            <button id="clapBtn" class="clap-btn">
                                <span class="material-symbols-outlined">favorite</span>
                                <span id="clapCount">-</span>
                            </button>
                            <div id="clappedStatus" style="display: none;">
                                <span class="material-symbols-outlined">favorite</span>
                                <span id="clapCountStatus">-</span><span>拍手完了</span>
                            </div>
                        </div>
                    </div>
                    <h2 id="infoTitle">作品標題</h2>
                    <p id="infoDesc">作品描述內容...</p>
                </div>
                <button class="info-nav-btn next" id="infoNext" onclick="changeWork(1)"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div id="viewerLayer" class="viewer-layer">
                <div class="viewer-img-container">
                    <button class="nav-btn prev-btn" id="viewPrev" onclick="changeInnerPage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <img id="viewerImg" src="" alt="Work Page">
                    <button class="nav-btn next-btn" id="viewNext" onclick="changeInnerPage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="viewer-indicator" id="viewerIndicator"></div>
            </div>
        </div>
    </div>
        <footer class="footer">
            <p>&copy; 2026 Takami's Gallery. All Rights Reserved.</p>
            <p>本站圖文禁止未經授權之轉載、AI 訓練與商業使用。</p>
            <p>sample@xmail.com</p>
            <ul class="sns-links">
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-plurk.png'); --hover: url('img/icon/icon-plurk-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-x.png'); --hover: url('img/icon/icon-x-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-bluesky.png'); --hover: url('img/icon/icon-bluesky-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-pixiv.png'); --hover: url('img/icon/icon-pixiv-hover.png');"></a></li>
            </ul>
        </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, off } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZ9fVnata2mqQb-YPceFKWEdKdQwL6nhA",
            authDomain: "takami-gallery.firebaseapp.com",
            databaseURL: "https://takami-gallery-default-rtdb.firebaseio.com",
            projectId: "takami-gallery",
            storageBucket: "takami-gallery.firebasestorage.app",
            messagingSenderId: "777768543738",
            appId: "1:777768543738:web:f8f0fcf7aa9cdc716f7043",
            measurementId: "G-JTZ69DZ4F4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentClapRef = null;

        document.getElementById('clapBtn').addEventListener('click', handleClap);

        window.syncClaps = function(workId) {
            if (!workId) return;
            const clapSection = document.getElementById('clapSection');
            const clapCountDisplay = document.getElementById('clapCount');
            const clapCountStatus = document.getElementById('clapCountStatus');

            clapSection.classList.remove('ready');
            if (clapCountDisplay) clapCountDisplay.innerText = "-";
            if (clapCountStatus) clapCountStatus.innerText = "-";

            checkClapLimit(workId);
            if (currentClapRef) off(currentClapRef);

            currentClapRef = ref(db, 'claps/' + workId);
            onValue(currentClapRef, (snapshot) => {
                const count = snapshot.val() || 0;
                if (clapCountDisplay) clapCountDisplay.innerText = count;
                if (clapCountStatus) clapCountStatus.innerText = count;
                setTimeout(() => { clapSection.classList.add('ready'); }, 50);
            });
        };

        // 檢查是否還在冷卻時間內 (60分鐘 = 3,600,000 毫秒)
        function checkClapLimit(workId) {
            const history = JSON.parse(localStorage.getItem('clap_history_map') || "{}");
            const lastClapTime = history[workId]; // 取得該作品上次點擊的時間戳記
            const now = Date.now();
            const cooldown = 60 * 60 * 1000; // 60 分鐘的毫秒數

            let isLocked = false;
            if (lastClapTime) {
                // 如果現在時間距離上次點擊小於冷卻時間，則鎖定按鈕
                if (now - lastClapTime < cooldown) {
                    isLocked = true;
                }
            }

            const clapBtn = document.getElementById('clapBtn');
            const clappedStatus = document.getElementById('clappedStatus');

            if (isLocked) {
                clapBtn.style.display = 'none';
                clappedStatus.style.display = 'flex';
            } else {
                clapBtn.style.display = 'flex';
                clappedStatus.style.display = 'none';
            }
        }

    // 儲存拍手時間戳記到 LocalStorage
    function saveClapToLocal(workId) {
        const history = JSON.parse(localStorage.getItem('clap_history_map') || "{}");
        history[workId] = Date.now(); // 紀錄目前時間
        localStorage.setItem('clap_history_map', JSON.stringify(history));
        checkClapLimit(workId);
    }

    // 處理點擊拍手
    function handleClap() {
        // 這裡需要能存取到 currentIndex 與 currentFilteredWorks
        // 確保這兩個變數在您的 global scope 或可存取範圍內
        const item = currentFilteredWorks[currentIndex];
        if (!item) return;

        const clapRef = ref(db, 'claps/' + item.id);
        runTransaction(clapRef, (current) => (current || 0) + 1);
        
        saveClapToLocal(item.id);
    }

    // 監聽按鈕點擊
    document.getElementById('clapBtn').addEventListener('click', handleClap);

    // 修改原本的 syncClaps 呼叫名
    window.syncClaps = function(workId) {
        if (!workId) return;
        const clapSection = document.getElementById('clapSection');
        const clapCountDisplay = document.getElementById('clapCount');
        const clapCountStatus = document.getElementById('clapCountStatus');

        clapSection.classList.remove('ready');
        if (clapCountDisplay) clapCountDisplay.innerText = "-";
        if (clapCountStatus) clapCountStatus.innerText = "-";

        // 每次切換作品時檢查該作品是否在冷卻中
        checkClapLimit(workId);

        if (currentClapRef) off(currentClapRef);
        currentClapRef = ref(db, 'claps/' + workId);
        onValue(currentClapRef, (snapshot) => {
            const count = snapshot.val() || 0;
            if (clapCountDisplay) clapCountDisplay.innerText = count;
            if (clapCountStatus) clapCountStatus.innerText = count;
            setTimeout(() => { clapSection.classList.add('ready'); }, 50);
        });
    }
    </script>

    <script>
        let allWorks = [];
        let currentFilteredWorks = []; 
        let currentIndex = 0;       
        let currentInnerIndex = 0;  
        let isViewerActive = false; 
        let uiInactivityTimeout; 
        let touchStartX = 0, touchStartY = 0, isSwiping = false;

        async function initGallery() {
            try {
                const response = await fetch('data/content.json');
                allWorks = await response.json();
                renderFilters();
                renderCategorizedGallery('All');
                initTouchEvents();
            } catch (err) { console.error("Load Failed:", err); }
        }

        function renderFilters() {
            const categories = ['All', ...new Set(allWorks.map(w => w.category))];
            document.getElementById('filterBar').innerHTML = categories.map(cat => `
                <button class="filter-btn ${cat === 'All' ? 'active' : ''}" onclick="handleFilterClick('${cat}', this)">${cat}</button>
            `).join('');
        }

        function handleFilterClick(category, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCategorizedGallery(category);
        }

        function renderCategorizedGallery(filterTag) {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';
            currentFilteredWorks = [];
            const cats = filterTag === 'All' ? [...new Set(allWorks.map(w => w.category))] : [filterTag];

            cats.forEach(cat => {
                const works = allWorks.filter(w => w.category === cat);
                const group = document.createElement('div');
                group.className = 'category-group';
                group.innerHTML = `<h2 class="category-title">${cat}</h2><div class="gallery-grid"></div>`;
                const grid = group.querySelector('.gallery-grid');
                
                works.forEach(work => {
                    const globalIdx = currentFilteredWorks.length;
                    currentFilteredWorks.push(work);
                    const card = document.createElement('div');
                    card.className = 'work-card';
                    card.onclick = () => openOverlay(globalIdx);
                    card.innerHTML = `
                        ${work.type === 'series' ? `<div class="series-badge"><i class="fa-solid fa-copy"></i> ${work.img.length}</div>` : ''}
                        <img src="img/gallery/${work.cover || work.img[0]}" alt="${work.title}">
                    `;
                    grid.appendChild(card);
                });
                container.appendChild(group);
            });
        }

        // 建立一個統一修正高度的函式
        function fixOverlayHeight() {
            const overlay = document.getElementById('workOverlay');
            if (overlay && overlay.classList.contains('active')) {
                // 使用 window.innerHeight 取得排除瀏覽器工具欄後的真實像素高度
                overlay.style.height = window.innerHeight + 'px';
            }
        }

        function openOverlay(index) {
            currentIndex = index;
            isViewerActive = false;
            currentInnerIndex = 0;
            document.getElementById('clapSection').classList.remove('ready');
            
            updateOverlayUI();
            
            const overlay = document.getElementById('workOverlay');
            overlay.classList.add('active');
            
            // 開啟時立即修正一次高度
            fixOverlayHeight();
            
            document.body.style.overflow = 'hidden';
            document.body.style.backgroundColor = '#000000'; // 開啟時將底色變黑
        }

        // 監聽螢幕旋轉或視窗大小改變（例如導覽列隱藏時）
        window.addEventListener('resize', fixOverlayHeight);

        // 額外處理：針對 iOS Chrome 導覽列消失後的瞬間補償
        window.addEventListener('scroll', () => {
            if (document.getElementById('workOverlay').classList.contains('active')) {
                fixOverlayHeight();
            }
        });

        function updateOverlayUI() {
            const item = currentFilteredWorks[currentIndex];
            if (!item) return;

            const coverFile = item.cover || (Array.isArray(item.img) ? item.img[0] : item.img);
            document.getElementById('infoCoverImg').src = `img/gallery/${coverFile}`;
            document.getElementById('infoTitle').innerText = item.title;
            document.getElementById('infoDesc').innerText = item.desc || "";
            document.getElementById('infoDate').innerText = item.date;

            const currentCat = item.category;
            const infoPrev = document.getElementById('infoPrev');
            const infoNext = document.getElementById('infoNext');
            if (infoPrev) infoPrev.style.visibility = (currentIndex > 0 && currentFilteredWorks[currentIndex-1].category === currentCat) ? 'visible' : 'hidden';
            if (infoNext) infoNext.style.visibility = (currentIndex < currentFilteredWorks.length - 1 && currentFilteredWorks[currentIndex+1].category === currentCat) ? 'visible' : 'hidden';

            const isSeries = item.type === 'series';
            const pageBadge = document.getElementById('infoPageCount');
            const coverBox = document.getElementById('infoCoverBox');

            if (isSeries) {
                pageBadge.innerText = `繼續閱讀 ${item.img.length}P`;
                pageBadge.classList.add('active');
                coverBox.classList.add('is-series');
            } else {
                pageBadge.classList.remove('active');
                coverBox.classList.remove('is-series');
            }

            if (isViewerActive && isSeries) {
                document.getElementById('infoLayer').style.display = 'none';
                document.getElementById('viewerLayer').classList.add('active');
                document.getElementById('overlayCloseBtn').style.display = 'none';
                document.getElementById('overlayBackBtn').style.display = 'flex';
                updateViewerImage();
            } else {
                document.getElementById('infoLayer').style.display = 'flex';
                document.getElementById('viewerLayer').classList.remove('active');
                document.getElementById('overlayCloseBtn').style.display = 'flex';
                document.getElementById('overlayBackBtn').style.display = 'none';
            }

            if (window.syncClaps) window.syncClaps(item.id);
        }

        function updateViewerImage() {
            const item = currentFilteredWorks[currentIndex];
            const imgs = item.img;
            document.getElementById('viewerImg').src = `img/gallery/${imgs[currentInnerIndex]}`;
            
            const viewPrev = document.getElementById('viewPrev');
            const viewNext = document.getElementById('viewNext');
            if (viewPrev) viewPrev.classList.toggle('btn-hidden', currentInnerIndex === 0);
            if (viewNext) viewNext.classList.toggle('btn-hidden', currentInnerIndex === imgs.length - 1);

            const indicator = document.getElementById('viewerIndicator');
            indicator.innerHTML = imgs.map((_, i) => `<span class="dot ${i === currentInnerIndex ? 'active' : ''}"></span>`).join('');
        }

        function changeWork(step) {
            const newIdx = currentIndex + step;
            if (newIdx >= 0 && newIdx < currentFilteredWorks.length) {
                if (currentFilteredWorks[newIdx].category === currentFilteredWorks[currentIndex].category) {
                    currentIndex = newIdx;
                    currentInnerIndex = 0;
                    document.getElementById('clapCount').innerText = "-";
                    document.getElementById('clapCountStatus').innerText = "-";
                    updateOverlayUI();
                }
            }
        }

        function changeInnerPage(step) {
            const item = currentFilteredWorks[currentIndex];
            const targetIndex = currentInnerIndex + step;
            if (targetIndex >= 0 && targetIndex < item.img.length) {
                currentInnerIndex = targetIndex;
                updateViewerImage();
            }
        }

        function enterViewer() { isViewerActive = true; currentInnerIndex = 0; updateOverlayUI(); }
        function backToInfo() { isViewerActive = false; updateOverlayUI(); }
        function closeOverlay() {
        document.getElementById('workOverlay').classList.remove('active');
        document.body.style.overflow = 'auto';
        document.body.style.backgroundColor = ''; // 關閉時還原底色
    }
        function handleOverlayClick(e) { if (e.target.id === 'workOverlay') closeOverlay(); }
        function tryEnterViewer() { if (currentFilteredWorks[currentIndex].type === 'series') enterViewer(); }

        function initTouchEvents() {
            const overlay = document.getElementById('workOverlay');
            
            overlay.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = true;
            }, {passive: false});

            overlay.addEventListener('touchmove', e => {
                if (!isSwiping) return;
                let dx = e.touches[0].clientX - touchStartX;
                let dy = e.touches[0].clientY - touchStartY;
                
                // 判斷是否為水平滑動
                if (Math.abs(dx) > Math.abs(dy)) {
                    // 禁止背景滾動
                    if (e.cancelable) e.preventDefault();
                    
                    const img = isViewerActive ? document.getElementById('viewerImg') : document.getElementById('infoCoverImg');
                    if(img) {
                        img.style.transform = `translateX(${dx * 0.25}px)`; // 移動圖片
                        img.style.transition = 'none'; // 拖動時不需要過渡動畫
                    }
                }
            }, {passive: false});

            overlay.addEventListener('touchend', e => {
                if (!isSwiping) return;
                isSwiping = false;
                
                let dx = e.changedTouches[0].clientX - touchStartX;
                const img = isViewerActive ? document.getElementById('viewerImg') : document.getElementById('infoCoverImg');
                
                if(img) {
                    img.style.transition = 'transform 0.3s ease';
                    img.style.transform = '';
                }

                // 滑動閾值 70px
                if (Math.abs(dx) > 70) {
                    if (dx < 0) {
                        // 向左滑 -> 下一張
                        isViewerActive ? changeInnerPage(1) : changeWork(1);
                    } else {
                        // 向右滑 -> 上一張
                        isViewerActive ? changeInnerPage(-1) : changeWork(-1);
                    }
                }
            }, {passive: true});
        }

        function resetUIInactivity() {
            const btns = [document.getElementById('overlayBackBtn'), document.getElementById('overlayCloseBtn')];
            btns.forEach(b => b && b.classList.remove('ui-hidden'));
            clearTimeout(uiInactivityTimeout);
            uiInactivityTimeout = setTimeout(() => {
                if (isViewerActive && window.innerWidth <= 900) btns.forEach(b => b && b.classList.add('ui-hidden'));
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', initGallery);
    </script>

    <script>
        const menuBtn = document.getElementById('menuBtn');
        const fullMenu = document.getElementById('fullMenu');
        let lastScrollY = window.scrollY;

        function toggleMenu() {
            if (!fullMenu || !menuBtn) return;
            const isActive = fullMenu.classList.toggle('active');
            isActive ? menuBtn.classList.add('hidden') : menuBtn.classList.remove('hidden');
        }

        window.addEventListener('scroll', () => {
            if (fullMenu.classList.contains('active')) return;
            const currentScrollY = window.scrollY;
            const delta = currentScrollY - lastScrollY;
            if (delta > 0 && currentScrollY > 50) {
                menuBtn.classList.add('hidden');
            } else if (delta < 0) {
                menuBtn.classList.remove('hidden');
            }
            lastScrollY = currentScrollY;
        });

        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
        document.addEventListener('copy', e => e.preventDefault());
    </script>
</body>
</html>