<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery | TAKAMI's Portfolio</title>
    <meta name="robots" content="noindex, nofollow, noimageindex">
    <meta name="pinterest" content="nopin" description="Sorry, you can't save from this website!" />
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" />
    <link rel="stylesheet" href="style.css">
    <!-- 導入PinchZoom.js -->
    <script src="https://unpkg.com/pinch-zoom-js@2.3.5/dist/pinch-zoom.min.js"></script>

</head>
<body class="page-gallery">

    <div class="menu-toggle" id="menuBtn" onclick="toggleMenu()">
        <i class="fa-solid fa-bars menu-icon"></i>
    </div>
    <nav class="full-menu" id="fullMenu">
        <div class="close-menu" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i></div>
        <a href="index.html">Home</a>
        <a href="new.html">New</a>
        <a href="gallery.html">Gallery</a>
        <a href="life.html">Life</a>
    </nav>

    <header class="page-hero page-hero-large ">
        <div class="page-hero-bg" style="background-image: url('img/index/gallery.jpg');"></div>
        <div class="hero-content"><h1>Gallery</h1><p>作品全集</p></div>
    </header>

    <main class="gallery-main">
        <div class="category-filter" id="filterBar"></div>
        <div id="galleryContainer"></div>
    </main>

    <div id="workOverlay" class="overlay" onclick="handleOverlayClick(event)" onmousemove="resetUIInactivity()" ontouchstart="resetUIInactivity()">
        <div id="overlayCloseBtn" class="overlay-close" onclick="closeOverlay()">
            <span class="material-symbols-outlined">close</span>
        </div>
        <div id="overlayBackBtn" class="overlay-back" onclick="backToInfo()">
            <span class="material-symbols-outlined">arrow_back</span>
        </div>

        <div class="overlay-content">
            <div id="infoLayer" class="info-layer">
                <button class="info-nav-btn prev" id="infoPrev" onclick="changeWork(-1)"><i class="fas fa-chevron-left"></i></button>
                <div id="infoCoverBox" class="info-cover-box" onclick="tryEnterViewer()">
                    <img id="infoCoverImg" src="" alt="Cover">
                    <span class="page-count-label" id="infoPageCount"></span>
                </div>
                <div class="info-details">
                    <div class="info-header-meta">
                        <div class="date-tag" id="infoDate"></div>
                        <div class="clap-section" id="clapSection">
                            <button id="clapBtn" class="clap-btn">
                                <span class="material-symbols-outlined">favorite</span>
                                <span id="clapCount">-</span>
                            </button>
                            <div id="clappedStatus" style="display: none;">
                                <span class="material-symbols-outlined">favorite</span>
                                <span id="clapCountStatus">-</span><span>拍手完了</span>
                            </div>
                        </div>
                    </div>
                    <h2 id="infoTitle">作品標題</h2>
                    <p id="infoDesc">作品描述內容...</p>
                </div>
                <button class="info-nav-btn next" id="infoNext" onclick="changeWork(1)"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div id="viewerLayer" class="viewer-layer">
                <div class="viewer-img-container">
                    <button class="nav-btn prev-btn" id="viewPrev" onclick="changeInnerPage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <img id="viewerImg" src="" alt="Work Page">
                    <button class="nav-btn next-btn" id="viewNext" onclick="changeInnerPage(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="viewer-indicator" id="viewerIndicator"></div>
            </div>
        </div>
    </div>
        <footer class="footer">
            <p>&copy; 2026 Takami's Gallery. All Rights Reserved.</p>
            <p>本站圖文禁止未經授權之轉載、AI 訓練與商業使用。</p>
            <p>sample@xmail.com</p>
            <ul class="sns-links">
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-plurk.png'); --hover: url('img/icon/icon-plurk-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-x.png'); --hover: url('img/icon/icon-x-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-bluesky.png'); --hover: url('img/icon/icon-bluesky-hover.png');"></a></li>
                <li><a href="#" class="sns-btn png-icon" style="--icon: url('img/icon/icon-pixiv.png'); --hover: url('img/icon/icon-pixiv-hover.png');"></a></li>
            </ul>
        </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, off } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZ9fVnata2mqQb-YPceFKWEdKdQwL6nhA",
            authDomain: "takami-gallery.firebaseapp.com",
            databaseURL: "https://takami-gallery-default-rtdb.firebaseio.com",
            projectId: "takami-gallery",
            storageBucket: "takami-gallery.firebasestorage.app",
            messagingSenderId: "777768543738",
            appId: "1:777768543738:web:f8f0fcf7aa9cdc716f7043",
            measurementId: "G-JTZ69DZ4F4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentClapRef = null;

        document.getElementById('clapBtn').addEventListener('click', handleClap);

        window.syncClaps = function(workId) {
            if (!workId) return;
            const clapSection = document.getElementById('clapSection');
            const clapCountDisplay = document.getElementById('clapCount');
            const clapCountStatus = document.getElementById('clapCountStatus');

            clapSection.classList.remove('ready');
            if (clapCountDisplay) clapCountDisplay.innerText = "-";
            if (clapCountStatus) clapCountStatus.innerText = "-";

            checkClapLimit(workId);
            if (currentClapRef) off(currentClapRef);

            currentClapRef = ref(db, 'claps/' + workId);
            onValue(currentClapRef, (snapshot) => {
                const count = snapshot.val() || 0;
                if (clapCountDisplay) clapCountDisplay.innerText = count;
                if (clapCountStatus) clapCountStatus.innerText = count;
                setTimeout(() => { clapSection.classList.add('ready'); }, 50);
            });
        };

        // 檢查是否還在冷卻時間內 (60分鐘 = 3,600,000 毫秒)
        function checkClapLimit(workId) {
            const history = JSON.parse(localStorage.getItem('clap_history_map') || "{}");
            const lastClapTime = history[workId]; // 取得該作品上次點擊的時間戳記
            const now = Date.now();
            const cooldown = 60 * 60 * 1000; // 60 分鐘的毫秒數

            let isLocked = false;
            if (lastClapTime) {
                // 如果現在時間距離上次點擊小於冷卻時間，則鎖定按鈕
                if (now - lastClapTime < cooldown) {
                    isLocked = true;
                }
            }

            const clapBtn = document.getElementById('clapBtn');
            const clappedStatus = document.getElementById('clappedStatus');

            if (isLocked) {
                clapBtn.style.display = 'none';
                clappedStatus.style.display = 'flex';
            } else {
                clapBtn.style.display = 'flex';
                clappedStatus.style.display = 'none';
            }
        }

    // 儲存拍手時間戳記到 LocalStorage
    function saveClapToLocal(workId) {
        const history = JSON.parse(localStorage.getItem('clap_history_map') || "{}");
        history[workId] = Date.now(); // 紀錄目前時間
        localStorage.setItem('clap_history_map', JSON.stringify(history));
        checkClapLimit(workId);
    }

    // 處理點擊拍手
    function handleClap() {
        // 這裡需要能存取到 currentIndex 與 currentFilteredWorks
        // 確保這兩個變數在您的 global scope 或可存取範圍內
        const item = currentFilteredWorks[currentIndex];
        if (!item) return;

        const clapRef = ref(db, 'claps/' + item.id);
        runTransaction(clapRef, (current) => (current || 0) + 1);
        
        saveClapToLocal(item.id);
    }

    // 監聽按鈕點擊
    document.getElementById('clapBtn').addEventListener('click', handleClap);

    // 修改原本的 syncClaps 呼叫名
    window.syncClaps = function(workId) {
        if (!workId) return;
        const clapSection = document.getElementById('clapSection');
        const clapCountDisplay = document.getElementById('clapCount');
        const clapCountStatus = document.getElementById('clapCountStatus');

        clapSection.classList.remove('ready');
        if (clapCountDisplay) clapCountDisplay.innerText = "-";
        if (clapCountStatus) clapCountStatus.innerText = "-";

        // 每次切換作品時檢查該作品是否在冷卻中
        checkClapLimit(workId);

        if (currentClapRef) off(currentClapRef);
        currentClapRef = ref(db, 'claps/' + workId);
        onValue(currentClapRef, (snapshot) => {
            const count = snapshot.val() || 0;
            if (clapCountDisplay) clapCountDisplay.innerText = count;
            if (clapCountStatus) clapCountStatus.innerText = count;
            setTimeout(() => { clapSection.classList.add('ready'); }, 50);
        });
    }
    </script>



    <!-- 主要邏輯 -->
    <script>
        let allWorks = [];
        let currentFilteredWorks = []; 
        let currentIndex = 0; 
        let currentInnerIndex = 0; 
        let isViewerActive = false; 
        let uiInactivityTimeout; 
        let touchStartX = 0, isSwiping = false;

        let pzInfo = null;
        let pzViewer = null;

        async function initGallery() {
            try {
                const response = await fetch('data/content.json');
                allWorks = await response.json();
                renderFilters();
                renderCategorizedGallery('All');
                initPinchZoom();
                initTouchEvents();
            } catch (err) { console.error("Load Failed:", err); }
        }

        function initPinchZoom() {
            const infoBox = document.getElementById('infoCoverBox');
            const viewerBox = document.querySelector('.viewer-img-container');

            // 修正：PinchZoom 構造函數通常直接在全域物件下
            const PZ = window.PinchZoom || (window.PinchZoom && window.PinchZoom.default);
            
            if (infoBox && PZ) {
                pzInfo = new PZ(infoBox, {
                    draggableUnzoomed: false,
                    minZoom: 1,
                    onZoomUpdate: () => resetUIInactivity()
                });
            }
            if (viewerBox && PZ) {
                pzViewer = new PZ(viewerBox, {
                    draggableUnzoomed: false,
                    minZoom: 1,
                    onZoomUpdate: () => resetUIInactivity()
                });
            }
        }

        function resetAllZoom(animated = false) {
            if (pzInfo) pzInfo.setZoomFactor(1, animated);
            if (pzViewer) pzViewer.setZoomFactor(1, animated);
        }

        function renderFilters() {
            const categories = ['All', ...new Set(allWorks.map(w => w.category))];
            document.getElementById('filterBar').innerHTML = categories.map(cat => `
                <button class="filter-btn ${cat === 'All' ? 'active' : ''}" onclick="handleFilterClick('${cat}', this)">${cat}</button>
            `).join('');
        }

        function handleFilterClick(category, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCategorizedGallery(category);
        }

        function renderCategorizedGallery(filterTag) {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';
            currentFilteredWorks = [];
            const cats = filterTag === 'All' ? [...new Set(allWorks.map(w => w.category))] : [filterTag];

            cats.forEach(cat => {
                const works = allWorks.filter(w => w.category === cat);
                const group = document.createElement('div');
                group.className = 'category-group';
                group.innerHTML = `<h2 class="category-title">${cat}</h2><div class="gallery-grid"></div>`;
                const grid = group.querySelector('.gallery-grid');
                
                works.forEach(work => {
                    const globalIdx = currentFilteredWorks.length;
                    currentFilteredWorks.push(work);
                    const card = document.createElement('div');
                    card.className = 'work-card';
                    card.onclick = () => openOverlay(globalIdx);
                    card.innerHTML = `
                        ${work.type === 'series' ? `<div class="series-badge"><i class="fa-solid fa-copy"></i> ${work.img.length}</div>` : ''}
                        <img src="img/gallery/${work.cover || work.img[0]}" alt="${work.title}">
                    `;
                    grid.appendChild(card);
                });
                container.appendChild(group);
            });
        }

        function fixOverlayHeight() {
            const overlay = document.getElementById('workOverlay');
            if (overlay && overlay.classList.contains('active')) {
                overlay.style.height = window.innerHeight + 'px';
            }
        }

        function openOverlay(index) {
            currentIndex = index;
            isViewerActive = false;
            currentInnerIndex = 0;
            resetAllZoom(false);
            updateOverlayUI();
            
            const overlay = document.getElementById('workOverlay');
            overlay.classList.add('active');
            fixOverlayHeight();
            document.body.style.overflow = 'hidden';
        }

        function updateOverlayUI() {
            const item = currentFilteredWorks[currentIndex];
            if (!item) return;

            const coverFile = item.cover || (Array.isArray(item.img) ? item.img[0] : item.img);
            document.getElementById('infoCoverImg').src = `img/gallery/${coverFile}`;
            document.getElementById('infoTitle').innerText = item.title;
            document.getElementById('infoDesc').innerText = item.desc || "";
            document.getElementById('infoDate').innerText = item.date;

            const currentCat = item.category;
            const infoPrev = document.getElementById('infoPrev');
            const infoNext = document.getElementById('infoNext');
            infoPrev.style.visibility = (currentIndex > 0 && currentFilteredWorks[currentIndex-1].category === currentCat) ? 'visible' : 'hidden';
            infoNext.style.visibility = (currentIndex < currentFilteredWorks.length - 1 && currentFilteredWorks[currentIndex+1].category === currentCat) ? 'visible' : 'hidden';

            const isSeries = item.type === 'series';
            const pageBadge = document.getElementById('infoPageCount');
            const coverBox = document.getElementById('infoCoverBox');

            if (isSeries) {
                pageBadge.innerText = `繼續閱讀 ${item.img.length}P`;
                pageBadge.style.display = 'block';
                coverBox.classList.add('is-series');
            } else {
                pageBadge.style.display = 'none';
                coverBox.classList.remove('is-series');
            }

            if (isViewerActive && isSeries) {
                document.getElementById('infoLayer').style.display = 'none';
                document.getElementById('viewerLayer').style.display = 'block';
                document.getElementById('overlayCloseBtn').style.display = 'none';
                document.getElementById('overlayBackBtn').style.display = 'flex';
                updateViewerImage();
            } else {
                document.getElementById('infoLayer').style.display = 'flex';
                document.getElementById('viewerLayer').style.display = 'none';
                document.getElementById('overlayCloseBtn').style.display = 'flex';
                document.getElementById('overlayBackBtn').style.display = 'none';
            }

            if (window.syncClaps) window.syncClaps(item.id);

            setTimeout(() => {
                if (pzInfo) pzInfo.update();
                if (pzViewer) pzViewer.update();
            }, 150);
        }

        function updateViewerImage() {
            const item = currentFilteredWorks[currentIndex];
            const imgs = item.img;
            const imgElement = document.getElementById('viewerImg');
            
            if (pzViewer) pzViewer.setZoomFactor(1, false);
            imgElement.src = `img/gallery/${imgs[currentInnerIndex]}`;
            
            imgElement.onload = function() {
                if (pzViewer) pzViewer.update();
            };

            document.getElementById('viewPrev').style.visibility = currentInnerIndex === 0 ? 'hidden' : 'visible';
            document.getElementById('viewNext').style.visibility = currentInnerIndex === imgs.length - 1 ? 'hidden' : 'visible';

            const indicator = document.getElementById('viewerIndicator');
            indicator.innerHTML = imgs.map((_, i) => `<span class="dot ${i === currentInnerIndex ? 'active' : ''}"></span>`).join('');
        }

        function changeWork(step) {
            const newIdx = currentIndex + step;
            if (newIdx >= 0 && newIdx < currentFilteredWorks.length) {
                if (currentFilteredWorks[newIdx].category === currentFilteredWorks[currentIndex].category) {
                    resetAllZoom(false);
                    currentIndex = newIdx;
                    currentInnerIndex = 0;
                    updateOverlayUI();
                }
            }
        }

        function changeInnerPage(step) {
            const item = currentFilteredWorks[currentIndex];
            const targetIndex = currentInnerIndex + step;
            if (targetIndex >= 0 && targetIndex < item.img.length) {
                resetAllZoom(false);
                currentInnerIndex = targetIndex;
                updateViewerImage();
            }
        }

        function enterViewer() { isViewerActive = true; currentInnerIndex = 0; updateOverlayUI(); }
        function backToInfo() { isViewerActive = false; updateOverlayUI(); }
        function handleOverlayClick(e) { if (e.target.id === 'workOverlay') closeOverlay(); }
        function tryEnterViewer() { if (currentFilteredWorks[currentIndex].type === 'series') enterViewer(); }

        function closeOverlay() {
            resetAllZoom(false);
            document.getElementById('workOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function initTouchEvents() {
            const infoBox = document.getElementById('infoCoverBox');
            const viewerBox = document.querySelector('.viewer-img-container');

            const handleStart = (e) => {
                const activePZ = isViewerActive ? pzViewer : pzInfo;
                // 只有在單指且倍率約等於 1 時才允許滑動切換
                if (e.touches.length === 1 && (!activePZ || activePZ.zoomFactor < 1.1)) {
                    touchStartX = e.touches[0].clientX;
                    isSwiping = true;
                } else {
                    isSwiping = false;
                }
            };

            const handleEnd = (e) => {
                if (!isSwiping) return;
                let dx = e.changedTouches[0].clientX - touchStartX;
                if (Math.abs(dx) > 60) {
                    if (dx < 0) {
                        isViewerActive ? changeInnerPage(1) : changeWork(1);
                    } else {
                        isViewerActive ? changeInnerPage(-1) : changeWork(-1);
                    }
                }
                isSwiping = false;
            };

            [infoBox, viewerBox].forEach(box => {
                if(box) {
                    box.addEventListener('touchstart', handleStart, {passive: true});
                    box.addEventListener('touchend', handleEnd, {passive: true});
                }
            });
        }

        function resetUIInactivity() {
            const btns = [document.getElementById('overlayBackBtn'), document.getElementById('overlayCloseBtn')];
            btns.forEach(b => b && b.classList.remove('ui-hidden'));
            clearTimeout(uiInactivityTimeout);
            uiInactivityTimeout = setTimeout(() => {
                if (isViewerActive && window.innerWidth <= 900) {
                    btns.forEach(b => b && b.classList.add('ui-hidden'));
                }
            }, 3000);
        }

        window.addEventListener('resize', fixOverlayHeight);
        document.addEventListener('DOMContentLoaded', initGallery);
    </script>

    <script src="main.js"></script>
</body>
</html>