<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life | TAKAMI's Artwork</title>
    <!-- 阻擋機器人及Pinterest -->
    <meta name="robots" content="index, follow, noai, max-image-preview:large">
    <meta name="pinterest" content="nopin" description="Sorry, you can't save from this website!" />
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <link rel="icon" href="/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-25..0" />
    <link rel="stylesheet" href="style.css">
    <style>
        /* 預設狀態：限制為兩行 */
        .content-wrapper .content-text {
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 限制顯示兩行 */
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.6;      /* 明確設定行高以便 JS 計算 */
            margin: 0;
        }

        /* 展開狀態：取消行數限制 */
        .blog-card.expanded .content-text {
            display: block;
            -webkit-line-clamp: initial;
            overflow: visible;
        }

        /* 隱藏展開後的 more 按鈕 (選擇性) */
        .blog-card.expanded .more-btn {
            display: none;
        }
    </style>
    
</head>
<body class="page-life">

    <div class="menu-toggle" id="menuBtn" onclick="toggleMenu()">
        <i class="fa-solid fa-bars menu-icon"></i>
    </div>
    <nav class="full-menu" id="fullMenu">
        <div class="close-menu" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i></div>
        <a href="index.html">Home</a>
        <a href="info.html">Info</a>
        <a href="gallery.html">Gallery</a>
        <a href="life.html">Life</a>
    </nav>

    <header class="page-hero page-hero-small " >
        <div class="page-hero-bg" ></div>
        <div class="hero-content"><h1>Life</h1><p>日常記録<br>写真・手描き・制作過程など</p></div>
    </header>

    <main class="blog-container">
        <div class="blog-list" id="blogList">
            </div>
        <div class="pagination" id="pagination">
            </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 TAKAMI</p>
        <p>無断加工・転載・商用利用・AI学習禁止</p>
        <p>No editing, reposting, commercial use, or AI training without written permission.<br>Fanart: Original characters &copy; their owners. | Original works: All rights reserved.</p>
    </footer>
    <div id="workOverlay" class="overlay" onclick="handleOverlayClick(event)">
        <div id="overlayCloseBtn" class="overlay-close overlay-icon" onclick="closeOverlay()">
            <span class="icon-svg icon-close"></span>
        </div>

        <div class="overlay-content">
            <div id="viewerLayer" class="viewer-layer viewer-layer-life" style="display: flex;">
                <div class="viewer-img-container">
                    <img id="viewerImg" src="" alt="Full Image">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // Firebase 初始化 (與 gallery 相同)
        const firebaseConfig = {
            apiKey: "AIzaSyDZ9fVnata2mqQb-YPceFKWEdKdQwL6nhA",
            authDomain: "takami-gallery.firebaseapp.com",
            databaseURL: "https://takami-gallery-default-rtdb.firebaseio.com",
            projectId: "takami-gallery",
            storageBucket: "takami-gallery.firebasestorage.app",
            messagingSenderId: "777768543738",
            appId: "1:777768543738:web:f8f0fcf7aa9cdc716f7043"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let allPosts = [];
        let currentPage = 1;
        const postsPerPage = 10;

        async function initBlog() {
            try {
                const response = await fetch('data/content_life.json');
                allPosts = await response.json();
                // 依日期排序 (最新的在前)
                allPosts.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderPage(1);
            } catch (err) {
                console.error("無法載入部落格資料:", err);
            }
        }

        function renderPage(page) {
            const blogList = document.getElementById('blogList');
            const pagination = document.getElementById('pagination');
            blogList.innerHTML = '';

            // 處理空內容情況
            if (allPosts.length === 0) {
                blogList.innerHTML = `
                    <div style="text-align: center; padding: 100px 0; color: #888; font-size: 1.2rem;">
                        <p>目前沒有文章 QQ</p>
                    </div>
                `;
                pagination.innerHTML = '';
                return;
            }

            currentPage = page;
            const start = (page - 1) * postsPerPage;
            const end = start + postsPerPage;
            const pagedPosts = allPosts.slice(start, end);

            pagedPosts.forEach(post => {
                const card = document.createElement('article');
                card.className = 'blog-card';

                // 渲染結構：預設加入 loading 類別
                card.innerHTML = `
                    <div class="blog-image">
                        <img src="img/life/${post.img}" alt="Blog Image" loading="lazy" 
                            onclick="event.stopPropagation(); openLifeViewer('img/life/${post.img}')" style="cursor: pointer;">
                    </div>
                    <div class="blog-main">
                        <div class="blog-meta">
                            <span class="date-tag">${post.date}</span>
                        </div>
                        <div class="blog-body">
                            <div class="content-wrapper">
                                <p class="content-text">${post.content}</p>
                            </div>
                            <button class="more-btn" style="display: none;">...more</button>
                        </div>
                    </div>
                `;
                blogList.appendChild(card);

                const imgContainer = card.querySelector('.blog-image');
                const imgElement = imgContainer.querySelector('img');
                const blogMain = card.querySelector('.blog-main');
                const contentText = card.querySelector('.content-text');
                const moreBtn = card.querySelector('.more-btn');

                // --- 邏輯 1：偵測圖片比例 (橫式 vs 直式) ---
                if (imgElement.complete) {
                    checkImageRatio();
                } else {
                    imgElement.onload = checkImageRatio;
                }

                function checkImageRatio() {
                    const width = imgElement.naturalWidth;
                    const height = imgElement.naturalHeight;
                    if (height >= width) {
                        imgContainer.classList.add('portrait-mode'); // 直式：固定 300px
                    } else {
                        imgContainer.classList.add('landscape-mode'); // 橫式：高度自適應
                    }
                }

            // --- 邏輯 2：計算文字行數與展開功能 ---
            if (window.innerWidth <= 900) {
                // 僅在手機版執行收合計算
                requestAnimationFrame(() => {
                    const style = window.getComputedStyle(contentText);
                    const lineHeight = parseFloat(style.lineHeight) || 24; 
                    const textHeight = contentText.scrollHeight;
                    const rowCount = Math.round(textHeight / lineHeight);

                    // 當實際行數大於 2 行時顯示按鈕
                    if (rowCount > 2) {
                        moreBtn.style.display = 'block'; 
                        blogMain.style.cursor = 'pointer';
                        blogMain.onclick = () => {
                            card.classList.toggle('expanded');
                        };
                    }
                });
            } else {
                // 電腦版：強制顯示所有內容，不綁定點擊事件
                moreBtn.style.display = 'none';
                blogMain.style.cursor = 'default';
                blogMain.onclick = null;
            }

                // 串接 Firebase 拍手數據 (維持原本邏輯)
                const clapRef = ref(db, 'claps/' + post.id);
                onValue(clapRef, (snap) => {
                    const clapCount = snap.val() || 0;
                    // 假設您 HTML 內有拍手顯示元素，請確保 ID 正確
                    const clapDisplay = card.querySelector(`#clap-${post.id}`);
                    if (clapDisplay) clapDisplay.innerText = clapCount;
                });
            });

            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderPagination() {
            const totalPages = Math.ceil(allPosts.length / postsPerPage);
            const container = document.getElementById('pagination');
            container.innerHTML = '';

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                btn.innerText = i;
                btn.onclick = () => renderPage(i);
                container.appendChild(btn);
            }
        }

        document.addEventListener('DOMContentLoaded', initBlog);
    </script>

    <script>
        // 開啟查看器
        function openLifeViewer(imgSrc) {
            const overlay = document.getElementById('workOverlay');
            const viewerImg = document.getElementById('viewerImg');
            
            if (overlay && viewerImg) {
                viewerImg.src = imgSrc;
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // 禁止底層捲動
            }
        }

        // 關閉查看器
        function closeOverlay() {
            const overlay = document.getElementById('workOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = ''; // 恢復捲動
            }
        }

        // 點擊背景關閉
        function handleOverlayClick(e) {
            if (e.target.id === 'workOverlay') {
                closeLifeOverlay();
            }
        }

    </script>
    

    <script src="main.js"></script>
</body>
</html>